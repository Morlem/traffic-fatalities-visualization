<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>SJ Traffic Deaths</title>
</head>

<style>
body{
    overflow: hidden;
    margin: 10px;
}

#title{
    font-size: 10px;
    background-color: #ccc;
}

.pane{
    border: 10px solid turquoise;
    corner-radius: 10px;
    height: 100%;
}
.graph{
    border: 1px solid gray;
    white-space:nowrap;
    margin-top: 10px;
}

.personDetail{
    border: 1px solid gray;
    white-space:nowrap;
    margin-top: 10px;
    padding: 8px;

}


.personDetail.bike{
    background-image: url("icons/noun_61699.png");
    background-position: right bottom;
    background-size: contain;
    background-repeat: no-repeat;
}

.personDetail.motorcycle{
    background-image: url("icons/noun_145963.png");
    background-position: right bottom;
    background-size: contain;
    background-repeat: no-repeat;
}

.graph div{
    height:20px;

}
.red{
    background-color: #ff8080;
}
.orange{
    background-color: #ffcc80;
}
.yellow{
    background-color: #ffff80;
}
.green{
    background-color: #80ff80;
}
.blue{
    background-color: #80b3ff;
}
.purple{
    background-color: #bf80ff;
}
.pink{
    background-color: #ff80bf;
}
.turquoise{
    background-color: #80dfff;
}
.bluer{
    background-color: #8080ff;
}

.borderClass{
    border-color: black;
    border-width: 2px;
    border-style: solid;
}

.grayBackground{
    background-color: #BBB;
}

.personPhoto{
    width: 100%;
}

.personInfo{
    width: 100px;
}

.pName{
    font-size: 20px;
    font-weight: bold;
}

.modeIcon{
    width: 100px;
    height: 100px;

}

</style>

<script src="jquery-3.1.1.min.js"></script>

<script type="text/javascript">

var lines = [];
var headers = [];

var modeNumbers = [];
var ageNumbers = [];
var genderNumbers = [];
var timeNumbers = [];

var modeLabels = ["driver", "carpassenger", "pedestrian", "motorcyclist", "bicyclist", "buspassenger"];
var ageLabels = ["0015", "1620", "2130", "3140", "4150", "5160", "6170", "7180", "81+"];
var genderLabels = ["female","male","unknown"];
var timeLabels = ["morning", "afternoon", "evening", "night"];
var roadTypeLabels = ["grand boulevard", "on-street primary bicycle facility", "main street", "city connector", "local connector", "freeway", "residential", "gas station","parking lot","mobile home park","inside building", "train track"]

var treerailLabels = ["yes", "no", "unknown"];
var alcoholLabels = ["yes", "no", "unknown"];
var arrestLabels = ["yes", "no", "unknown"];
var onepartyLabels = ["yes", "no", "unknown"];
var trainLabels = ["yes", "no", "unknown"];

var selectedRows = [];

color = ["red","turquoise","orange","green","yellow","blue","pink","bluer","purple"];

$(document).ready(function(){
    $.ajax({
        type: "GET",
        url: "trafficdata.txt",
        dataType: "text",
        success: function(data) {processData(data);}
    });

    selectedRows = [];
    for (var i = 0; i < 60; i++) {
        selectedRows.push(1);
    }

});

function processData(allText) {
    var allTextLines = allText.split(/\r\n|\n/);
    headers = allTextLines[0].split(',');

    for (var i=1; i<allTextLines.length; i++) {
        var data = allTextLines[i].split(',');
        if (data.length == headers.length) {

            var tarr = [];
            for (var j=0; j<headers.length; j++) {
                tarr.push(headers[j]+":"+data[j]);
            }
            lines.push(tarr);
        }
    }

    for (var k=1; k<headers.length; k++){
        var dataArray = [];
        eval(headers[k] + " = getCol(lines, " + k + ")" );
    }

    drawBarGraphs();
}

function drawBarGraphs(){

    $("#g1").empty();
    $("#g2").empty();
    $("#g3").empty();
    $("#g4").empty();
    $("#g5").empty();

    modeNumbers = [
        compute(mode, modeLabels[0]),
        compute(mode,modeLabels[1]),
        compute(mode,modeLabels[2]),
        compute(mode,modeLabels[3]),
        compute(mode,modeLabels[4]),
        compute(mode,modeLabels[5])
    ];

    ageNumbers = [
        computeRange(age,parseInt(ageLabels[0].substring(0,2)),parseInt(ageLabels[0].substring(2,4))),
        computeRange(age,parseInt(ageLabels[1].substring(0,2)),parseInt(ageLabels[1].substring(2,4))),
        computeRange(age,parseInt(ageLabels[2].substring(0,2)),parseInt(ageLabels[2].substring(2,4))),
        computeRange(age,parseInt(ageLabels[3].substring(0,2)),parseInt(ageLabels[3].substring(2,4))),
        computeRange(age,parseInt(ageLabels[4].substring(0,2)),parseInt(ageLabels[4].substring(2,4))),
        computeRange(age,parseInt(ageLabels[5].substring(0,2)),parseInt(ageLabels[5].substring(2,4))),
        computeRange(age,parseInt(ageLabels[6].substring(0,2)),parseInt(ageLabels[6].substring(2,4))),
        computeRange(age,parseInt(ageLabels[7].substring(0,2)),parseInt(ageLabels[7].substring(2,4))),
        computeRange(age,parseInt(ageLabels[8].substring(0,2)),150)
    ];

    genderNumbers = [
        compute(gender,genderLabels[0]),
        compute(gender,genderLabels[1]),
        compute(gender,genderLabels[2])
    ];
    timeNumbers = [
        computeTime(time,7,12),
        computeTime(time,13,18),
        computeTime(time,19,24),
        computeTime(time,0,6)
    ];
    roadTypeNumbers = [
        compute(roadType, roadTypeLabels[0]),
        compute(roadType,roadTypeLabels[1]),
        compute(roadType,roadTypeLabels[2]),
        compute(roadType,roadTypeLabels[3]),
        compute(roadType,roadTypeLabels[4]),
        compute(roadType,roadTypeLabels[5]),
        compute(roadType,roadTypeLabels[6]),
        compute(roadType,roadTypeLabels[7]),
        compute(roadType,roadTypeLabels[8]),
        compute(roadType,roadTypeLabels[9]),
        compute(roadType,roadTypeLabels[10]),
        compute(roadType,roadTypeLabels[11]),
    ];
    for(i=0; i<modeLabels.length;i++)
    {
        $("#g1").append("<div id='"+modeLabels[i]+"' class='mode "+color[i]+"' onclick=handleClick(mode,"+ modeLabels[i] + ") style='width:"+((100*modeNumbers[i])/Math.max.apply(Math,modeNumbers))+"%;'>"+modeLabels[i]+" ("+modeNumbers[i]+")</div>");
    }

    for(i=0; i<ageLabels.length;i++)
    {
        // $("#g2").append("<div id='a"+ageLabels[i]+"' class='age "+color[i]+"' onclick=handleClick(age,"+ ageLabels[i] + ")				style='width:"+((100*ageNumbers[i])/Math.max.apply(Math,ageNumbers))+"%;'>"+ageLabels[i].substring(0,2) + "-" + ageLabels[i].substring(2,4) + " ("+ageNumbers[i]+")</div>");
        let catName = ageLabels[i];
        let div = $.parseHTML("<div id='a"+ageLabels[i]+"' class='age "+color[i]+"' 				style='width:"+((100*ageNumbers[i])/Math.max.apply(Math,ageNumbers))+"%;'>"+ageLabels[i].substring(0,2) + "-" + ageLabels[i].substring(2,4) + " ("+ageNumbers[i]+")</div>");
        $(div).click(
            ()=>{handleClick(age, catName)}
        )
        $("#g2").append(div);
    }
    for(i=0; i<genderLabels.length;i++)
    {
        $("#g3").append("<div id='"+genderLabels[i]+"' class='gender "+color[i]+"' onclick=handleClick(gender,"+ genderLabels[i] + ")		style='width:"+((100*genderNumbers[i])/Math.max.apply(Math,genderNumbers))+"%;'>"+genderLabels[i]+" ("+genderNumbers[i]+")</div>");
    }
    for(i=0; i<timeLabels.length; i++)
    {
        $("#g4").append("<div id='"+timeLabels[i]+"' class='time "+color[i]+"' onclick=handleClick(time,"+ timeLabels[i] + ")		style='width:"+((100*timeNumbers[i])/Math.max.apply(Math,timeNumbers))+"%;'>"+timeLabels[i]+" ("+timeNumbers[i]+")</div>");
    }
    for(i=0; i<roadTypeLabels.length; i++)
    {
        $("#g5").append("<div id='"+roadTypeLabels[i]+"' class='roadType "+color[i]+"' onclick=handleClick(roadType,"+ roadTypeLabels[i] + ")		style='width:"+((100*roadTypeNumbers[i])/Math.max.apply(Math,roadTypeNumbers))+"%;'>"+roadTypeLabels[i]+" ("+roadTypeNumbers[i]+")</div>");
    }
}

function handleClick(category,id){
    if(category[0].startsWith("age")){
        if(id.substring(0,2) == 81){
            getRowsRange(age, id.substring(0,2), 150);
        }
        else{
            getRowsRange(age, id.substring(0,2), id.substring(2,4));
        }
    }
    else{
        getRows(category, id.id);
    }

    drawBarGraphs();
}

function clearSelection(category,id){

}

function compute(col, filter){
    var count = 0;
    for(var i=0; i<col.length; ++i){
        if(selectedRows[i] == 1 && col[i].split(':')[1] == filter){
            count++;
        }
    }
    return count;
}

function computeTime(col, filter1, filter2){
    let count = 0;
    for (var i=0; i<col.length; ++i){
        if(selectedRows[i] == 1 && col[i].split(':')[1] >= filter1 && col[i].split(':')[1] <= filter2)
        {
            count++;
        }
    }
    return count;
}

function getRows(col, filter){
    var count = 0;
    for(var i=0; i<col.length; ++i){
        if(selectedRows[i] == 1 && col[i].split(':')[1] == filter){
            count++;
        }
        else{
            selectedRows[i] = 0;
        }
    }
    return selectedRows;

}

function getRowsRange(col, filter1, filter2){
    var count = 0;
    for(var i=0; i<col.length; ++i){
        let ageData = parseInt(col[i].split(':')[1]);
        if(selectedRows[i] == 1 && ageData >= filter1 && ageData <= filter2){
            count++;
        }
        else{
            selectedRows[i] = 0;
        }
    }
    return selectedRows;

}


function computeRange(col, filter1, filter2){
    var count = 0;
    for(var i=0; i<col.length; ++i){
        let ageData = parseInt(col[i].split(':')[1]);

        if(selectedRows[i] == 1 && ageData >= filter1 && ageData <= filter2){
            count++;
        }
    }
    return count;
}

function getCol(matrix, col){
    var column = [];
    for(var i=0; i<matrix.length; i++){
        column.push(matrix[i][col]);
    }
    return column;
}

</script>

<div class="row col-md-12" id="title">San Jose Traffic Deaths</div>

<div class="row">
    <div class="pane col-md-2">

        <span class="pane-title">Selector</span>

        <div class="graph" id="g1"></div>
        <div class="graph" id="g2"></div>
        <div class="graph" id="g3"></div>
        <div class="graph" id="g4"></div>
        <div class="graph" id="g5"></div>
    </div>

    <div class="pane col-md-7">
        <span class="pane-title">Map</span>
    </div>

    <div class="pane col-md-3">
        <span class="pane-title">Detail Pane</span>

        <div class="personDetail bike" id="p1">
            <div class="row">
                <div class="col-md-3">
                    <img class="personPhoto" src="photos/mikhailtsitsiline.jpg">
                </div>
                <div class="personInfo col-md-8 ">
                    <span class="pName">Mikhail Tsitsiline</span>
                    <br>
                    <span class="pDate">1/2/2016</span>
                    <span class="pTime">19:08</span>
                    <br>
                    <span class="pMode">bicyclist</span>
                    <span class="pLocation">South Seventh &amp; Reed Street</span>
                    <span class="pGender">male</span>
                    <span class="pAge">41</span>
                </div>
            </div>
        </div>

        <div class="personDetail motorcycle" id="p2">
            <div class="row">
                <div class="col-md-3">
                    <img class="personPhoto" src="photos/jaredsandoval.jpg">
                </div>
                <div class="personInfo col-md-8">
                    <span class="pName">Jared Sandoval</span>
                    <br>
                    <span class="pDate">1/12/2016</span>
                    <span class="pTime">8:13</span>
                    <br>
                    <span class="pMode">motorcyclist</span>
                    <span class="pLocation">Hillsdale Avenue &amp; Kirk Road</span>
                    <span class="pGender">male</span>
                    <span class="pAge">23</span>
                </div>
            </div>
        </div>
    </div>
</div>
</html>
